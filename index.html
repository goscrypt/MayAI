<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart AI Chatbot with JS Code Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background-color: #f0f2f5;
    }
    .container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      text-align: center;
    }
    #chatLog {
      width: 100%;
      height: 300px;
      margin-top: 10px;
      padding: 10px;
      font-family: monospace;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
      box-sizing: border-box;
      background-color: #fafafa;
    }
    .input-group {
      display: flex;
      margin-top: 10px;
    }
    #userInput {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #sendBtn {
      padding: 10px 20px;
      margin-left: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #sendBtn:hover {
      background-color: #0056b3;
    }
    #fileInput {
      width: 100%;
      margin-top: 10px;
    }
    .loading-message {
      text-align: center;
      color: #555;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>🤖 Smart AI Chatbot + JS Code Assistant</h2>
    <input type="file" id="fileInput" accept=".txt, .md, .csv">
    <textarea id="chatLog" readonly placeholder="Chat log will appear here..."></textarea>
    <div class="input-group">
      <input type="text" id="userInput" placeholder="Ask a question or request code...">
      <button id="sendBtn">Send</button>
    </div>
    <div id="statusMessage" class="loading-message"></div>
  </div>

  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.1/dist/transformers.esm.js';

    let questionAnswerer;
    let codeGenerator;
    let fileContext = '';
    const chatLog = document.getElementById('chatLog');
    const fileInput = document.getElementById('fileInput');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusMessage = document.getElementById('statusMessage');

    const codeTriggers = [
      "create a program",
      "write a code",
      "generate a function",
      "create a sample",
      "build a script",
      "make a function",
      "code a solution"
    ];

    function isCodeRequest(text) {
      const lower = text.toLowerCase();
      return codeTriggers.some(trigger => lower.includes(trigger));
    }

    async function initModels() {
      statusMessage.textContent = "⌛ Loading AI models...";
      sendBtn.disabled = true;

      questionAnswerer = await pipeline(
        'question-answering',
        'Xenova/distilbert-base-uncased-distilled-squad'
      );

      // Swap in the JS‐specialized model here:
      codeGenerator = await pipeline(
        'text-generation',
        'microsoft/codegpt-small-js'
      );

      statusMessage.textContent = "✅ Models loaded (JS Code Assistant ready)";
      sendBtn.disabled = false;
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        fileContext = await file.text();
        chatLog.textContent += `📄 File loaded: ${file.name}\n\n`;
      }
    });

    async function sendMessage() {
      const input = userInput.value.trim();
      if (!input) return;
      if (!questionAnswerer || !codeGenerator) {
        await initModels();
      }

      chatLog.textContent += `You: ${input}\n`;
      userInput.value = '';
      statusMessage.textContent = "🤖 Thinking...";
      sendBtn.disabled = true;

      try {
        let reply;
        const wantsCode = isCodeRequest(input);
        const hasFile    = fileContext.trim().length > 0;

        if (wantsCode) {
          // JS code generation path
          const out = await codeGenerator(
            `// JavaScript\n${input}`,
            { max_new_tokens: 150 }
          );
          reply = out[0].generated_text;
          statusMessage.textContent = "🧑‍💻 JS Code Assistant Mode";
        } else {
          // QA over uploaded file
          if (!hasFile) {
            reply = "📂 Please upload a file so I can answer questions about it.";
            statusMessage.textContent = "📄 File Q&A (no file loaded)";
          } else {
            const resp = await questionAnswerer(
              { question: input, context: fileContext }
            );
            reply = resp.answer;
            statusMessage.textContent = "📄 File Q&A Mode";
          }
        }

        chatLog.textContent += `Bot: ${reply}\n\n`;
        chatLog.scrollTop = chatLog.scrollHeight;
      } catch (err) {
        chatLog.textContent += `Bot: ❌ Error: ${err.message}\n\n`;
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    window.addEventListener('load', initModels);
  </script>
</body>
</html>
